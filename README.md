# 2RTK NTRIP Caster v2.2.0

**Language / Выбор языка:**
- [English](README-en.md)
- [中文版 / Chinese](README-zh.md)
- [Русский](#) (Текущий)

---

Это простой NTRIP caster, написанный на Python, поддерживающий протоколы NTRIP v1.0 и v2.0, управляемый через веб-интерфейс.
Вы можете использовать веб-интерфейс для добавления пользователей и точек монтирования в браузере, а также для просмотра информации о подключениях NTRIP caster.
Он поддерживает высокую одновременную нагрузку и может обрабатывать 2000+ одновременных подключений. (Из-за ограничений моей тестовой среды я тестировал только с 2 источниками RTCM данных. 2000 одновременных загрузок данных пользователями, но его производительность отличная)

Раньше это был один файл 2rtk.py, но я недавно переработал его. Теперь он выглядит намного больше, но я всё ещё считаю его относительно лёгким. lol

- Веб-управление. Так что вы можете развернуть его на любом облачном хосте.
- Использует базу данных SQLite для хранения информации о пользователях и точках монтирования.
- Использует библиотеку pyrtcm для парсинга загруженных данных и исправления таблиц STR (эта часть кода переписывалась несколько раз. Но я всё ещё недоволен ею, включая текущую версию. Ожидайте последующих обновлений).
    (Вам просто нужно добавить точку монтирования на веб-странице и загрузить данные RTCM, 2rtk-NtripCaster автоматически сгенерирует информацию STR и распарсит данные RTCM для извлечения типов данных и информации о местоположении для исправления STR)
- Этот NTRIP caster всё ещё далёк от caster в моём представлении. Я буду постепенно улучшать его в свободное время.
- Он поддерживает большинство систем с окружением Python, включая debian, ubuntu, centos, armbian и т.д.
- Поддерживает развёртывание через Docker.

## Туториалы по установке

### Развёртывание через Docker (Рекомендуется)
Рекомендуется одноразовое развёртывание, ручная настройка не требуется.
```bash
# Загрузить и запустить напрямую, образ автоматически создаст необходимые каталоги и конфигурационные файлы
docker run -d \
  --name ntrip-caster \
  -p 2101:2101 \
  -p 5757:5757 \
  2rtk/ntripcaster:latest
```
- **Русский туториал**: [Руководство по установке и использованию Docker](DOCKER-TUTORIAL.md)
- **中文教程 / Chinese Tutorial**: [Docker 安装和使用教程](DOCKER-TUTORIAL.md)
- **English Tutorial**: [Docker Installation and Usage Guide](DOCKER-TUTORIAL-EN.md)

### Нативная установка в Debian
- **Русский туториал**: [Руководство по установке в Linux](INSTALL-TUTORIAL.md)
- **中文教程 / Chinese Tutorial**: [Linux 系统原生安装教程](INSTALL-TUTORIAL.md)
- **English Tutorial**: [Linux Native Installation Guide](INSTALL-TUTORIAL-EN.md)

**Адреса доступа**:
-  Веб-интерфейс управления: `http://yourserverip:5757`
-  Служба NTRIP: `ntrip://yourserverip:2101`
-  Учётная запись по умолчанию: `admin` / `admin123` (не забудьте изменить пароль по умолчанию)

## Рекомендации по оборудованию

### Минимальные требования к конфигурации
- **CPU**: 2 ядра (рекомендуется архитектура x86_64)
- **Память**: 2GB RAM
- **Хранилище**: 10GB доступного дискового пространства
- **Сеть**: стабильное сетевое соединение
- **Операционная система**: Ubuntu 18.04+ / Debian 10+ / CentOS 7+

## Функции веб-интерфейса

### Главная страница
Вы можете видеть текущее состояние работы caster на главной странице, включая количество подключений, количество пользователей, количество точек монтирования и т.д. Информация в логах ниже будет отправлять в реальном времени состояние подключений пользователей или точек монтирования. Режим DEBUG будет отправлять больше отладочной информации.

![Главная страница](img/Home.png)

### Страница управления пользователями
Вы можете добавлять пользователей, удалять пользователей, изменять пароли пользователей и т.д. на странице управления пользователями. Также можно видеть пользователей в сети. (Позже будет добавлено управление пользователями, API зарезервирован)

![Управление пользователями](img/user.png)

### Страница управления точками монтирования
Вы можете добавлять точки монтирования, удалять точки монтирования, изменять информацию о точках монтирования и т.д. на странице управления точками монтирования. Также можно видеть информацию в сети. (Позже будет добавлено управление точками монтирования, API зарезервирован)

![Управление точками монтирования](img/mount.png)

### Страница информации о базовой станции
Вы можете просматривать состояние RTCM на странице информации о базовой станции. Нажмите кнопку INFO перед записью STR, и серверная часть выполнит парсинг и отобразит это в информации ниже. (Обычно требуется некоторое время на парсинг, прежде чем обновится отображение)

![Информация о базовой станции](img/rtcm.png)

### Рекомендации по конфигурации для различных нагрузок

| Количество одновременных подключений | CPU | Память | Хранилище | Сетевая пропускная способность |
|-----------|-----|------|------|----------|
| **< 100** | 1 ядро | 1GB | 5GB | 10Mbps |
| **100-500** | 2 ядра | 2GB | 10GB | 50Mbps |
| **500-1000** | 4 ядра | 4GB | 20GB | 100Mbps |
| **1000-2000** | 8 ядер | 8GB | 50GB | 200Mbps |
| **2000+** | 16 ядер+ | 16GB+ | 100GB+ | 500Mbps+ |

### Рекомендации по облачным серверам
При развёртывании на облачном сервере откройте порты 5757 и 2101 в настройках безопасности
#### AWS EC2
- **Начальный уровень**: t3.small (2 ядра 2GB)
- **Стандартный**: c5.large (2 ядра 4GB)
- **Высокая производительность**: c5.2xlarge (8 ядер 16GB)

## Тесты производительности

- **Тест 500 подключений**: CPU 18.1%, память 29.5%, сеть 7.47 Mbps
- **Тест 1000 подключений**: CPU 19.1%, память 33.9%, сеть 10.79 Mbps  
- **Предельный тест 2000 подключений**: CPU 17.3%, память 30.3%, сеть 7.69 Mbps

> Подробные отчёты о тестировании см. в каталоге [tests/](tests/)

## Руководство по конфигурации

### Основные параметры конфигурации

```ini
[ntrip]
port = 2101                    # Порт службы NTRIP
max_connections = 5000         # Максимальное количество подключений

[web] 
port = 5757                    # Порт веб-управления
refresh_interval = 10          # Интервал обновления данных

[performance]
thread_pool_size = 5000        # Размер пула потоков для одновременных подключений
max_workers = 5000             # Максимальное количество рабочих потоков
ring_buffer_size = 60          # Размер кольцевого буфера

[security]
secret_key = your-secret-key   # В production-среде измените ключ по умолчанию

[admin]
username = admin               # Имя пользователя администратора
password = admin123            # Пароль администратора (в production-среде измените)
```

### Диагностика распространённых проблем

#### Проблемы с занятостью портов
```bash
# Проверка занятости портов
sudo netstat -tlnp | grep :2101    # Порт NTRIP
sudo netstat -tlnp | grep :5757    # Порт веб-управления
sudo lsof -i :2101                 # Просмотр использования порта

# Освобождение порта
sudo kill -9 <PID>                 # Принудительное завершение процесса
sudo fuser -k 2101/tcp             # Принудительное освобождение порта
```

#### Проблемы с сетевым подключением
```bash
# Проверка файрвола
sudo ufw status                    # Файрвол Ubuntu
sudo firewall-cmd --list-all       # Файрвол CentOS

# Открытие портов
sudo ufw allow 2101/tcp            # Порт NTRIP
sudo ufw allow 5757/tcp            # Порт веб-управления

# Тестирование сетевой связности
telnet localhost 2101              # Тест порта NTRIP
curl http://localhost:5757/        # Тест веб-порта
```

#### Служба не запускается
```bash
# Проверка статуса службы
sudo systemctl status 2rtk

# Просмотр подробных логов
sudo journalctl -u 2rtk -f

# Проверка конфигурационного файла
python3 -c "import configparser; c=configparser.ConfigParser(); c.read('config.ini'); print('Синтаксис конфигурационного файла корректен')"

# Проверка прав доступа к порту
sudo netstat -tlnp | grep :2101
```

#### Проблемы с базой данных
```bash
# Проверка прав доступа к файлу базы данных
ls -la data/2rtk.db

# Пересоздание базы данных (действуйте осторожно)
rm data/2rtk.db
python3 main.py  # Автоматически создаст новую базу данных
```

#### Слишком высокое использование памяти
```bash
# Мониторинг использования памяти
top -p $(pgrep -f "python.*main.py")

# Настройка конфигурации для снижения использования памяти
# В config.ini уменьшите следующие параметры:
# max_connections = 1000
# thread_pool_size = 1000
# ring_buffer_size = 30
```

### Оптимизация производительности

#### Конфигурация высокой одновременной нагрузки
```ini
# Оптимизированная конфигурация config.ini
[ntrip]
max_connections = 10000            # Максимальное количество подключений
port = 2101

[performance]
thread_pool_size = 10000           # Размер пула потоков
max_workers = 10000                # Максимальное количество рабочих потоков
ring_buffer_size = 60              # Кольцевой буфер

[network]
buffer_size = 16384                # Сетевой буфер
timeout = 30                       # Таймаут подключения
```

### Мониторинг и логирование

#### Конфигурация уровня логирования
```ini
# Конфигурация логирования config.ini
[logging]
level = INFO                       # DEBUG, INFO, WARNING, ERROR
format = json                      # json, text
rotate_size = 100MB               # Размер ротации логов
rotate_count = 10                 # Количество сохраняемых файлов логов
```

## Вклад в проект

- Приветствуется отправка Pull Request
- Контакты: i@jia.by

## Благодарности и открытые библиотеки

Этот проект использует следующие отличные открытые библиотеки и инструменты, мы выражаем искреннюю благодарность:

### Основные зависимости

| Библиотека | Версия | Назначение | Лицензия |
|----|------|------|--------|
| **Flask** | 2.3.3 | Веб-фреймворк, предоставляет HTTP-службы и API | BSD-3-Clause |
| **Flask-SocketIO** | 5.3.6 | Поддержка WebSocket для связи в реальном времени | MIT |
| **python-socketio** | 5.8.0 | Реализация протокола Socket.IO | MIT |
| **psutil** | 5.9.5 | Мониторинг производительности системы и статистика ресурсов | BSD-3-Clause |
| **pyproj** | 3.6.1 | Преобразование геодезических систем координат и вычисление проекций | MIT |

### Библиотека парсинга RTCM

**pyrtcm** - Основная библиотека парсинга сообщений RTCM
- **Источник**: Интегрирована на основе исходного кода стандартной библиотеки [pyrtcm](https://github.com/semuconsulting/pyrtcm)
- **Версия**: Интегрированная версия (для предотвращения риска удаления репозитория источника)
- **Автор**: semuconsulting
- **Лицензия**: BSD-3-Clause
- **Назначение**: Предоставляет полный функционал парсинга, кодирования и декодирования сообщений RTCM 3.x
- **Примечание**: Для обеспечения стабильности проекта рекомендуется напрямую интегрировать исходный код библиотеки pyrtcm в проект, чтобы избежать рисков внешних зависимостей

## Открытая лицензия

Этот проект лицензирован под лицензией [Apache License 2.0](LICENSE).

### Лицензии сторонних библиотек

- **pyrtcm**: Лицензия BSD-3-Clause
- **Серия Flask**: Лицензия MIT/BSD  
- **psutil**: Лицензия BSD-3-Clause
- **pyproj**: Лицензия MIT

Все интегрированные сторонние библиотеки сохраняют свои первоначальные открытые лицензии. При использовании соблюдайте соответствующие условия лицензий.

---

**Если этот проект помог вам, пожалуйста, поставьте Star!**
